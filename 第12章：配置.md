# æ¦‚è¿°

åº”ç”¨ç¨‹åºé€šå¸¸åœ¨ä¸åŒçš„ **ç¯å¢ƒ** ä¸­è¿è¡Œã€‚æ ¹æ®ç¯å¢ƒçš„ä¸åŒï¼Œåº”è¯¥ä½¿ç”¨ä¸åŒçš„é…ç½®ã€‚ä¾‹å¦‚ï¼Œå¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒè®¿é—®çš„æ•°æ®åº“å‡­æ®æ˜¯ä¸ä¸€æ ·çš„ï¼Œåˆæ¯”å¦‚è¯´ï¼Œå½“æˆ‘ä»¬éœ€è¦è®¿é—®ç¬¬ä¸‰æ–¹æ¥å£æ—¶ï¼Œä¸ºäº†é€‚åº”å¼€å‘çš„ä¸åŒé˜¶æ®µï¼Œç¬¬ä¸‰æ–¹æœåŠ¡è‚¯å®šä¼šè‡³å°‘æä¾›æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„æ¥å£åœ°å€ï¼Œè€Œä½ åœ¨ä¸åŒç¯å¢ƒåº”è¯¥æ­£ç¡®è°ƒç”¨ã€‚ç”±äºé…ç½®å˜é‡ä¼šæ›´æ”¹ï¼Œæ‰€ä»¥æœ€ä½³å®è·µæ˜¯å°†é…ç½®å˜é‡å­˜å‚¨åœ¨ç¯å¢ƒä¸­ï¼Œæ‰€ä»¥åœ¨è¿™é‡Œï¼Œé…ç½®å˜é‡åˆç§°ä¸º **ç¯å¢ƒå˜é‡**ã€‚

åœ¨ `Node.js` åº”ç”¨ç¨‹åºä¸­ï¼Œé€šå¸¸ä½¿ç”¨ `.env` æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«é”®å€¼å¯¹ï¼Œå…¶ä¸­æ¯ä¸ªé”®ä»£è¡¨ä¸€ä¸ªç‰¹å®šçš„å€¼ï¼Œä»¥ä»£è¡¨æ¯ä¸ªç¯å¢ƒã€‚ åœ¨ä¸åŒçš„ç¯å¢ƒä¸­è¿è¡Œåº”ç”¨ç¨‹åºä»…æ˜¯äº¤æ¢æ­£ç¡®çš„`.env` æ–‡ä»¶çš„é—®é¢˜ã€‚

åœ¨ `Nest` ä¸­ä½¿ç”¨è¿™ç§æŠ€æœ¯çš„ä¸€ä¸ªå¥½æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ª `ConfigModule` ï¼ˆæˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚åŠ¨æ€æ¨¡å—ä¸­å·²æåˆ°ï¼‰ï¼Œå®ƒæš´éœ²ä¸€ä¸ª `ConfigService` ï¼Œæ ¹æ® `$NODE_ENV` ç¯å¢ƒå˜é‡åŠ è½½é€‚å½“çš„ `.env` æ–‡ä»¶ã€‚è™½ç„¶æ‚¨å¯ä»¥é€‰æ‹©è‡ªå·±ç¼–å†™è¿™æ ·çš„æ¨¡å—ï¼Œä½†ä¸ºæ–¹ä¾¿èµ·è§ï¼ŒNest æä¾›äº†å¼€ç®±å³ç”¨çš„`@ nestjs/config`è½¯ä»¶åŒ…ã€‚ 

# å®‰è£…

è¦å¼€å§‹ä½¿ç”¨å®ƒï¼Œæˆ‘ä»¬é¦–å…ˆå®‰è£…æ‰€éœ€çš„ä¾èµ–é¡¹ï¼š

```shell
$ npm i --save @nestjs/config
```

# å¼€å§‹ä½¿ç”¨

å®‰è£…å®Œæˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥`ConfigModule`æ¨¡å—ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨æ ¹æ¨¡å—`AppModule`ä¸­å¯¼å…¥å®ƒï¼Œå¹¶ä½¿ç”¨`.forRoot()`é™æ€æ–¹æ³•å¯¼å…¥å®ƒçš„é…ç½®ã€‚

```typescript
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';

@Module({
  imports: [ConfigModule.forRoot()],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

ä¸Šè¿°ä»£ç å°†ä»é»˜è®¤ä½ç½®ï¼ˆé¡¹ç›®æ ¹ç›®å½•ï¼‰è½½å…¥å¹¶è§£æä¸€ä¸ª `.env` æ–‡ä»¶ï¼Œä» `.env` æ–‡ä»¶å’Œ `process.env` åˆå¹¶ç¯å¢ƒå˜é‡é”®å€¼å¯¹ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åˆ°ä¸€ä¸ªå¯ä»¥é€šè¿‡`ConfigService` è®¿é—®çš„ç§æœ‰å±æ€§ä¸­ã€‚`forRoot()` æ–¹æ³•æ³¨å†Œäº† `ConfigService` æä¾›è€…ï¼Œåè€…æä¾›äº†ä¸€ä¸ª`get()`æ–¹æ³•æ¥è¯»å–è¿™äº›è§£æ/åˆå¹¶çš„é…ç½®å˜é‡ã€‚å½“ä¸€ä¸ªé”®åŒæ—¶ä½œä¸ºç¯å¢ƒå˜é‡å­˜åœ¨äºè¿è¡Œç¯å¢ƒä¸­ä»¥åŠ `.env` æ–‡ä»¶ä¸­æ—¶ï¼Œä»¥è¿è¡Œç¯å¢ƒå˜é‡ä¼˜å…ˆã€‚

ç°åœ¨æˆ‘ä»¬åœ¨æ ¹ç›®å½•æ–°å»º `.env` æ–‡ä»¶ï¼Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```
DATABASE_USER=admin
DATABASE_PASSWORD=123
```

> **ï¼æç¤º**ï¼šå…¶å®åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ `process.env.xxx` çš„å½¢å¼è®¿é—® `.env` æ–‡ä»¶ä¸­æ‰€å®šä¹‰çš„å˜é‡å€¼ã€‚

ä¸ºäº†ä½¿å¾—ç¨‹åºèƒ½å¤Ÿè‡ªåŠ¨è¯†åˆ«ä½ å®šä¹‰çš„ç¯å¢ƒå˜é‡ï¼Œä½ å¯ä»¥æ„å»ºå…¨å±€ç±»å‹å£°æ˜æ–‡ä»¶ï¼š*`typings/global.d.ts`*

```typescript
export declare global {
  namespace NodeJS {
    interface ProcessEnv {
      DATABASE_USER: string;
      DATABASE_PASSWORD: number;
    }
  }
}
```

è¿™æ ·ä½ åœ¨ä½¿ç”¨æ—¶ï¼Œå¦‚ `process.env.DATABASE_USER` å³å¯è·å¾—ç±»å‹æç¤ºã€‚å½“ç„¶ï¼Œæˆ‘ä»¬è¿™é‡Œè¿˜æ˜¯é€šè¿‡ `ConfigService` æ¥è®¿é—®ã€‚

ç°åœ¨åœ¨ `app.controller.ts` ä¸­è®¿é—®ï¼š

```typescript
import { Controller, Get } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

@Controller()
export class AppController {
  // -- æ³¨å…¥ConfigService
  constructor(private readonly configService: ConfigService) {}
  @Get()
  getHello() {
    return this.configService.get('DATABASE_USER');
  }
}
```

æµè§ˆå™¨æŸ¥çœ‹ http://localhost:3000/ è¾“å‡º `admin`

## è‡ªå®šä¹‰ env æ–‡ä»¶è·¯å¾„

é»˜è®¤æƒ…å†µä¸‹ï¼Œç¨‹åºåœ¨åº”ç”¨ç¨‹åºçš„æ ¹ç›®å½•ä¸­æŸ¥æ‰¾`.env`æ–‡ä»¶ã€‚ è¦ä¸º`.env`æ–‡ä»¶æŒ‡å®šå¦ä¸€ä¸ªè·¯å¾„ï¼Œè¯·é…ç½®`forRoot()`çš„é…ç½®å¯¹è±¡ `envFilePath` å±æ€§(å¯é€‰)ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```typescript
ConfigModule.forRoot({
  envFilePath: '.development.env',
});
```

## ç¦æ­¢åŠ è½½ç¯å¢ƒå˜é‡

å¦‚æœæ‚¨ä¸æƒ³åŠ è½½ `.env` æ–‡ä»¶ï¼Œè€Œæ˜¯æƒ³ç®€å•åœ°ä»è¿è¡Œæ—¶ç¯å¢ƒè®¿é—®ç¯å¢ƒå˜é‡ï¼ˆå¦‚ OS shell å¯¼å‡ºï¼Œä¾‹å¦‚`export DATABASE_USER = test`ï¼‰ï¼Œåˆ™å°†`options`å¯¹è±¡çš„`ignoreEnvFile`å±æ€§è®¾ç½®ä¸º`true`ï¼Œå¦‚ä¸‹æ‰€ç¤º ï¼š

```typescript
ConfigModule.forRoot({
  ignoreEnvFile: true,
});
```

## å…¨å±€ä½¿ç”¨

å½“æ‚¨æƒ³åœ¨å…¶ä»–æ¨¡å—ä¸­ä½¿ç”¨ `ConfigModule` æ—¶ï¼Œéœ€è¦å°†å…¶å¯¼å…¥ï¼ˆè¿™æ˜¯ä»»ä½• Nest æ¨¡å—çš„æ ‡å‡†é…ç½®ï¼‰ã€‚ æˆ–è€…ï¼Œé€šè¿‡å°† `options` å¯¹è±¡çš„ `isGlobal` å±æ€§è®¾ç½®ä¸º `true`ï¼Œå°†å…¶å£°æ˜ä¸ºå…¨å±€æ¨¡å—ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°† `ConfigModule` åŠ è½½åˆ°æ ¹æ¨¡å—ï¼ˆä¾‹å¦‚ `AppModule`ï¼‰åï¼Œæ‚¨æ— éœ€åœ¨å…¶ä»–æ¨¡å—ä¸­å¯¼å…¥å®ƒã€‚

```typescript
ConfigModule.forRoot({
  isGlobal: true,
});
```

## è‡ªå®šä¹‰é…ç½®æ–‡ä»¶

å¯¹äºæ›´å¤æ‚çš„é¡¹ç›®ï¼Œæ‚¨å¯ä»¥åˆ©ç”¨è‡ªå®šä¹‰é…ç½®æ–‡ä»¶è¿”å›åµŒå¥—çš„é…ç½®å¯¹è±¡ã€‚ è¿™ä½¿æ‚¨å¯ä»¥æŒ‰åŠŸèƒ½å¯¹ç›¸å…³é…ç½®è®¾ç½®è¿›è¡Œåˆ†ç»„ï¼ˆä¾‹å¦‚ï¼Œä¸æ•°æ®åº“ç›¸å…³çš„è®¾ç½®ï¼‰ï¼Œå¹¶å°†ç›¸å…³è®¾ç½®å­˜å‚¨åœ¨å•ä¸ªæ–‡ä»¶ä¸­ï¼Œä»¥å¸®åŠ©ç‹¬ç«‹ç®¡ç†å®ƒä»¬ã€‚

è‡ªå®šä¹‰é…ç½®æ–‡ä»¶å¯¼å‡ºä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œè¯¥å‡½æ•°è¿”å›ä¸€ä¸ªé…ç½®å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

*`config/configuration.ts`*

```typescript
export default () => ({
  name: 'Li-HONGYAO',
  database: {
    host: 'http://localhost',
    port: 27017,
    dbName: 'examples',
  },
});
```

æ¥ä¸‹æ¥åœ¨ `app.module.ts` ä¸­é€šè¿‡ `forRoot` æä¾›ç»™çš„ `load` å±æ€§æ¥åŠ è½½è¿™ä¸ªæ–‡ä»¶ï¼š

```typescript
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import configuration from './config/configuration';

@Module({
  imports: [
    ConfigModule.forRoot({
      load: [configuration],
    }),
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

æœ€åä¿®æ”¹ `app.controller.ts`ï¼ŒæŸ¥çœ‹æ•ˆæœï¼š

```typescript
import { Controller, Get } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

@Controller()
export class AppController {
  // -- æ³¨å…¥ConfigService
  constructor(private readonly configService: ConfigService) {}
  @Get()
  getHello() {
    return {
      name: this.configService.get('name'),
      dbHost: this.configService.get('database.host'),
    };
  }
}
```

æµè§ˆå™¨æŸ¥çœ‹ http://localhost:3000/ è¾“å‡ºç»“æœä¸ºï¼š

```json
{"name":"Li-HONGYAO","dbHost":"http://localhost"}
```

## é…ç½®å‘½åç©ºé—´

`ConfigModule` æ¨¡å—å…è®¸æ‚¨å®šä¹‰å’ŒåŠ è½½å¤šä¸ªè‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œå¦‚ä¸Šé¢çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ‰€ç¤ºã€‚æ‚¨å¯ä»¥ä½¿ç”¨åµŒå¥—çš„é…ç½®å¯¹è±¡æ¥ç®¡ç†å¤æ‚çš„é…ç½®å¯¹è±¡å±‚æ¬¡ç»“æ„ï¼Œå¦‚æœ¬èŠ‚æ‰€ç¤ºã€‚æˆ–è€…ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨`registerAs()`å‡½æ•°è¿”å›ä¸€ä¸ªâ€œå¸¦åç§°ç©ºé—´â€çš„é…ç½®å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤º:

```typescript
export default registerAs('database', () => ({
  host: "http:localhost"
  port: 27017
}));
```

> **ï¼æ³¨æ„** `registerAs` å‡½æ•°æ˜¯ä» `@nestjs/config` åŒ…å¯¼å‡ºçš„ã€‚

ä½¿ç”¨`forRoot()`çš„`load`æ–¹æ³•è½½å…¥å‘½åç©ºé—´çš„é…ç½®ï¼Œå’Œè½½å…¥è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ–¹æ³•ç›¸åŒï¼š

```typescript
// config/database.config.ts
import databaseConfig from './config/database.config';

@Module({
  imports: [
    ConfigModule.forRoot({
      load: [databaseConfig],
    }),
  ],
})
export class AppModule {}
```

ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨æ ‡å‡†çš„æ„é€ å‡½æ•°æ³¨å…¥ï¼Œå¹¶åœ¨æˆ‘ä»¬çš„ç±»ä¸­ä½¿ç”¨å®ƒï¼šç°åœ¨ï¼Œè¦ä»æ•°æ®åº“å‘½åç©ºé—´è·å–`host`çš„å€¼ï¼Œè¯·ä½¿ç”¨ç¬¦å·`.`ã€‚ä½¿ç”¨`database`ä½œä¸ºå±æ€§åç§°çš„å‰ç¼€ï¼Œè¯¥å±æ€§åç§°å¯¹åº”äºå‘½åç©ºé—´çš„åç§°ï¼ˆä½œä¸ºä¼ é€’ç»™`registerAs()`å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼‰

```typescript
const dbHost = this.configService.get<string>('database.host');
```

ä¸€ä¸ªåˆç†çš„æ›¿ä»£æ–¹æ¡ˆæ˜¯ç›´æ¥æ³¨å…¥`'database'`çš„å‘½åç©ºé—´ï¼Œæˆ‘ä»¬å°†ä»å¼ºç±»å‹ä¸­è·ç›Šï¼š

```typescript
constructor(
  @Inject(databaseConfig.KEY)
  private dbConfig: ConfigType<typeof databaseConfig>,
) {}
```

> **ï¼æ³¨æ„** `ConfigType` å‡½æ•°æ˜¯ä» `@nestjs/config` åŒ…å¯¼å‡ºçš„ã€‚

# ç¤ºä¾‹ï¼šå®é™…åº”ç”¨

ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼Œå¹¶æ²¡æœ‰æåˆ°å¦‚ä½•æ ¹æ®ç¯å¢ƒçš„å˜åŒ–æ¥é€‰æ‹©å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼Œç°åœ¨åˆ† å¼€å‘ç¯å¢ƒ/æµ‹è¯•ç¯å¢ƒ/ç”Ÿäº§ç¯å¢ƒæ¥å®šä¹‰é…ç½®æ–‡ä»¶ï¼Œé‚£å¦‚ä½•è®©æˆ‘ä»¬çš„ç¨‹åºå¯ä»¥åŒºåˆ†ç¯å¢ƒæ¥æ­£ç¡®çš„åŠ è½½é…ç½®æ–‡ä»¶å‘¢ï¼Ÿè¿™æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šä¸€èŠ‚æåˆ°çš„ **åŠ¨æ€æ¨¡å—** æ¥å®ç°ï¼Œä¸è¿‡æˆ‘å¤§æ¦‚ç‡ä¸ä¼šè¿™ä¹ˆåšï¼Œå› ä¸º Nest å·²ç»å†…ç½®äº† `@nestjs/config`ï¼Œæ‰€ä»¥æˆ‘è§‰å¾—æ²¡å¿…è¦ï¼Œæˆ‘ä»¬åªéœ€è¦ç¨ä½œä¿®æ”¹ï¼Œçµæ´»è¿ç”¨å³å¯ã€‚

ä¸è¿‡ï¼Œå¼€å§‹ä¹‹å‰ï¼Œæˆ‘æƒ³ç»™å¤§å®¶åˆ†äº«çš„æ˜¯ï¼Œå½“æˆ‘ä»¬æŠŠé¡¹ç›®æ‰“åŒ…ä¹‹åä¼šç”Ÿæˆä¸€ä¸ª `dist` æ–‡ä»¶ï¼Œé€šå¸¸æˆ‘çš„åšæ³•æ˜¯å°† `package.json` æ‹·è´ä¸€ä»½åˆ° `dist` ç›®å½•ä¸­ï¼Œç„¶åå°† `dist` ç›®å½•æ”¾åˆ°æœåŠ¡å™¨ä¸Šï¼Œå¹¶å®‰è£…ä¾èµ–ï¼Œé€šè¿‡ `PM2` å¯åŠ¨ã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œæˆ‘æœ€å¼€å§‹æ˜¯ä¸€åå‰ç«¯å¼€å‘è€…ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå‰ç«¯é¡¹ç›®ä¸­æ‰“åŒ…æ—¶ä¼šæ ¹æ®ä½ çš„ç¯å¢ƒå˜é‡æ¥æ³¨å…¥å¯¹åº”ç¯å¢ƒçš„å˜é‡å€¼ï¼Œä½†æ˜¯æˆ‘å‘ç°nodeå¹¶ä¸ä¼šï¼Œè¿™å°±æ„å‘³ç€ä½ éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š

1. å¦‚ä½•åœ¨éƒ¨ç½²æ—¶å¯ä»¥åƒæœ¬åœ°å¼€å‘ä¸€æ ·ï¼Œé€šè¿‡ `cross-env` æˆ–è€… `NODE_ENV` è®©ç¨‹åºå¯ä»¥åˆ†ç¯å¢ƒåŠ è½½å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Ÿè¿™ä¸ªé—®é¢˜ PM2 å¯ä»¥è§£å†³ï¼
2. ä½ æ˜¯å¦å—å‰ç«¯å¼€å‘çš„å½±å“ï¼Œå–œæ¬¢åœ¨æ ¹ç›®å½•å®šä¹‰ç±»ä¼¼ `.env.dev`/`.env.pro` çš„é…ç½®æ–‡ä»¶ï¼Œç„¶ååœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶åˆ†ç¯å¢ƒåŠ è½½ï¼Ÿå¦‚æœä½ è¦è¿™æ ·åšï¼Œé‚£ä½ åœ¨æ‰“åŒ…ä¹‹åè¿˜éœ€è¦å°†å¯¹åº”çš„é…ç½®æ–‡ä»¶ä¹Ÿæ‹·è´åˆ° `dist` ç›®å½•ä¸­ã€‚

é‰´äºè¯¸å¤šæ€è€ƒï¼Œæœ€ç»ˆæŒ‡å®šäº†å¦‚ä¸‹æ–¹æ¡ˆç”¨äºæˆ‘çš„å®é™…å¼€å‘ä¸­ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä»é›¶å¼€å§‹é…ç½®ï¼š

## å®‰è£…ä¾èµ–

```shell
$ npm i --save @nestjs/config
$ npm i --save-dev cross-env
```

> **Tipsï¼š**ç”±äº windows å¹³å°ä¸æ”¯æŒ *`NODE_ENV=development`* æ–¹å¼ï¼Œæ‰€ä»¥éœ€è¦ *`cross-env`* ä¾èµ–å…¼å®¹ã€‚

ä¿®æ”¹ `package.json` æ–‡ä»¶ä¸­çš„æ‰§è¡ŒæŒ‡ä»¤ï¼Œä½ å¯ä»¥æ ¹æ®ç¯å¢ƒæ¥è®¾å®šï¼š

```json
{
    "start:dev": "cross-env NODE_ENV=development nest start --watch",
    "start:prod": "cross-env NODE_ENV=production node dist/main",
    "start:test": "cross-env NODE_ENV=test node dist/main",
}
```

## è‡ªå®šä¹‰é…ç½®æ–‡ä»¶

é¦–å…ˆæ„é€ å¦‚ä¸‹ç›®å½•ç»“æ„ï¼š

```
.
â”œâ”€â”€ /src  
	  â”œâ”€â”€	/configs
	      â”œâ”€â”€ /envs â†’ é…ç½®æ–‡ä»¶
	      		â”œâ”€â”€ default.ts â†’ é»˜è®¤é…ç½®æ–‡ä»¶/è¿™é‡Œçš„é…ç½®å°†ä¼šå’Œå„ç¯å¢ƒé…ç½®æ–‡ä»¶è¿›è¡Œåˆå¹¶/å¯å®šä¹‰é€šç”¨çš„å˜é‡
	      		â”œâ”€â”€ development.ts â†’ å¼€å‘ç¯å¢ƒ
	      		â”œâ”€â”€ production.ts â†’ ç”Ÿäº§ç¯å¢ƒ
	      		â””â”€â”€	test.ts â†’ æµ‹è¯•ç¯å¢ƒ
	      â”œâ”€â”€ config.interface.ts â†’ ç±»å‹å®šä¹‰
	      â”œâ”€â”€ configuration.ts â†’ è‡ªå®šä¹‰é…ç½®æ–‡ä»¶
	  	  â””â”€â”€	index.ts â†’ ç»Ÿä¸€å¯¼å‡º
â”œâ”€â”€ ....
```

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å„æ–‡ä»¶ä¸‹çš„å…·ä½“å†…å®¹ï¼š

**`src/configs/envs/default.ts`**

```typescript
// ğŸ‘‰ é»˜è®¤é…ç½®
export const config = {
  app: {
    port: 3000,
    prefix: '/api',
  },
};
```

**`src/configs/envs/development.ts`**

```typescript
// ğŸ‘‰ å¼€å‘ç¯å¢ƒ
export const config = {
  apiHost: 'è¯·æ±‚ä¸‰æ–¹æœåŠ¡å™¨ä½¿ç”¨çš„åŸŸåï¼ˆå¼€å‘ç¯å¢ƒï¼‰',
  mongoose: {
    uri: 'mongodb://lee:123456@127.0.0.1:27017/local-database',
  },
};
```

**`src/configs/envs/production.ts`**

```typescript
// ğŸ‘‰ ç”Ÿäº§ç¯å¢ƒ
export const config = {
  apiHost: 'è¯·æ±‚ä¸‰æ–¹æœåŠ¡å™¨ä½¿ç”¨çš„åŸŸåï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰',
  mongoose: {
    uri: 'mongodb://lee:123456@127.0.0.1:27017/local-database',
  },
};
```

**`src/configs/envs/test.ts`**

```typescript
// ğŸ‘‰ æµ‹è¯•ç¯å¢ƒ
export const config = {
  apiHost: 'è¯·æ±‚ä¸‰æ–¹æœåŠ¡å™¨ä½¿ç”¨çš„åŸŸåï¼ˆæµ‹è¯•ç¯å¢ƒï¼‰',
  mongoose: {
    uri: 'mongodb://lee:123456@127.0.0.1:27017/local-database',
  },
};
```

**`src/configs/interface.d.ts`**

```typescript
import type { config as base } from './envs/default';
import type { config as dev } from './envs/production';
import type { config as pro } from './envs/development';
import type { config as test } from './envs/test';

export type Objectype = Record<string, unknown>;
export type Default = typeof base;
export type Development = typeof dev;
export type Production = typeof pro;
export type Test = typeof test;
export type Config = Default & Development & Production & Test;
```

**`src/configs/configuration.ts`**

```typescript
import type { Objectype, Config } from './config.interface';

const util = {
  // -- æ ¡éªŒæ˜¯å¦ä¸ºå¯¹è±¡
  isObject<T>(value: T): value is T & Objectype {
    return value !== null && typeof value === 'object' && !Array.isArray(value);
  },
  // -- æ‰§è¡Œåˆå¹¶
  merge<T extends Objectype, U extends Objectype>(target: T, source: U): T & U {
    for (const key of Object.keys(source)) {
      const targetValue = target[key];
      const sourceValue = source[key];
      if (this.isObject(targetValue) && this.isObject(sourceValue)) {
        Object.assign(sourceValue, this.merge(targetValue, sourceValue));
      }
    }
    return { ...target, ...source };
  },
};

export const configuration = async (): Promise<Config> => {
  // -- å¯¼å…¥é»˜è®¤é…ç½®
  const { config } = await import('./envs/default');
  // -- æ ¹æ®å½“å‰ç¯å¢ƒï¼ˆprocess.env.NODE_ENVï¼‰åŠ è½½å¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä¸º development ç¯å¢ƒ
  const { config: environment } = <{ config: Config }>await import(`./envs/${process.env.NODE_ENV || 'development'}`);
  // -- æ‰§è¡Œåˆå¹¶ï¼Œå¹¶å¯¼å‡º
  return util.merge(config, environment);
};
```

**`src/configs/index.ts`**

```typescript
export * from './config.interface';
export * from './configuration';
```

## æ¨¡å—å¯¼å…¥

å‰æœŸå‡†å¤‡å·¥ä½œå®Œæˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥`ConfigModule`æ¨¡å—ã€‚é€šå¸¸ï¼Œæˆ‘ä»¬åœ¨æ ¹æ¨¡å— `AppModule` ä¸­å¯¼å…¥å®ƒï¼Œå¹¶ä½¿ç”¨`.forRoot()` é™æ€æ–¹æ³•å¯¼å…¥å®ƒçš„é…ç½®ã€‚

```typescript
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { configuration } from './configs';

@Module({
  imports: [
    // â†’ é…ç½®æ¨¡å—
    ConfigModule.forRoot({
      cache: true,
      isGlobal: true,
      load: [configuration],
    })
  ],
  controllers: [],
})
export class AppModule {}
```

## ä½¿ç”¨

ç°åœ¨æ‚¨å¯ä»¥ç®€å•åœ°åœ¨ä»»ä½•åœ°æ–¹æ³¨å…¥ `ConfigService` ï¼Œå¹¶æ ¹æ®ä¼ é€’çš„å¯†é’¥æ£€ç´¢ç‰¹å®šçš„é…ç½®å€¼

```typescript
import { Injectable } from '@nestjs/common';
import { IResponse } from 'src/common/interfaces/response.interface';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class HelloService {
  constructor(private configService: ConfigService /** æ³¨å…¥configService  */) {}
  async testEnv(): Promise<IResponse> {
    // -- è¯»å–ç¯å¢ƒå˜é‡å¹¶è¿”å›
    return { code: 0, data: this.configService.get('jwtSecret') };
  }
}
```

**åœ¨ `main.ts` ä¸­ä½¿ç”¨ `ConfigService`**

```typescript
import { NestFactory } from '@nestjs/core';
import { ConfigService } from '@nestjs/config';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);
  const config = app.get(ConfigService); // å–å¾— ConfigService
  const port = config.get('port');
  await app.listen(port);
}
bootstrap();
```



