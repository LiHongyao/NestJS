# mongoose

- [mongo 官方文档 >>](https://docs.nestjs.cn/8/techniques?id=mongo)
- [MongoDB >>](https://ithelp.ithome.com.tw/articles/10278750)

## 安装依赖

```shell
$ npm install --save @nestjs/mongoose mongoose
$ npm install --save-dev @types/mongoose
```

## 配置

输入指令，生成 `database` 模块：

```shell
$ nest g mo database
```

### Schema

在 Mongoose 中，一切都源于 [Scheme](https://mongoosejs.com/docs/guide.html)，每个 Schema 都会映射到 MongoDB 的一个集合，并定义集合内文档的结构。Schema 被用来定义模型，而模型负责从底层创建和读取 MongoDB 的文档。

Schema 可以用 NestJS 内置的装饰器来创建，或者也可以自己动手使用 Mongoose 的 [常规方式](https://mongoosejs.com/docs/guide.html)。使用装饰器来创建 Schema 会极大大减少引用并且提高代码的可读性。这里作者用的是官方推荐方式用装饰器来创建。

*`src/database/schemas/user.schema.ts`*

```typescript
import { Prop, Schema, SchemaFactory } from '@nestjs/mongoose';
import { Document } from 'mongoose';

export type UserDocument = User & Document;

// -- @Schema 装饰器标记一个类作为Schema 定义
// -- @Prop 装饰器在文档中定义了一个属性
@Schema({ versionKey: false, collection: 'users' })
export class User extends Document {
  @Prop({ unique: true, required: true })
  phone: string;

  @Prop()
  password: string;

  @Prop()
  name: string;

  @Prop()
  job: string;
}

export const UserSchema = SchemaFactory.createForClass(User);
```

更多 Scheme 选项，[参照这里 >>](https://mongoosejs.com/docs/guide.html#options)

### Module

*`src/database/database.module.ts`*

```typescript
import { Global, Module } from '@nestjs/common';
import { MongooseModule } from '@nestjs/mongoose';
import { UserSchema } from './schemas/user.schema';

// -- 此模块使用 forFeature() 方法定义在当前范围中注册哪些存储库。
// -- 如果有多张表，直接在数组中加配置就可以了
const MONGO_MODELS = MongooseModule.forFeature([
  {
    name: 'USER_MODEL',
    schema: UserSchema,
  },
]);

@Global()
@Module({
  imports: [MongooseModule.forRoot('mongodb://lee:123@127.0.0.1:27017/DB-TEST'), MONGO_MODELS],
  exports: [MONGO_MODELS],
})
export class DatabaseModule {}
```

MongooseModule 提供了 `forFeature()` 方法来配置模块，包括定义哪些模型应该注册在当前范围中。

配置完之后，我们还需要在 *`app.module.ts`* 导入 `DbModule`：

```typescript
import { Module } from '@nestjs/common';
import { DatabaseModule } from './database/database.module';

@Module({
  imports: [
    DatabaseModule
  ],
  controllers: [],
})
export class AppModule {}
```

## 应用

为了更好的演示示例，我们构建一个 `user` 模块，并实现注册功能：

```shell
$ nest g mo shared/user
$ nest g co shared/user
$ nest g s shared/user
```

用户注册需用对密码进行加密，加密手段可参照 [中间件 示例1：加密中间件 >>](#示例1：加密中间件) 章节。

继续后续操作...

*`src/common/dto/req/create-user.dto.ts`*

```typescript
import { ApiProperty } from '@nestjs/swagger';

export class CreateUserDto {
  @ApiProperty({ description: '姓名' })
  name: string;
  @ApiProperty({ description: '手机号' })
  phone: string;
  @ApiProperty({ description: '密码' })
  password: string;
  @ApiProperty({ description: '年龄' })
  age: number;
  @ApiProperty({ description: '性别' })
  sex: number;
  @ApiProperty({ description: '工作' })
  job: string;
}
```

*`src/shared/user/user.service.ts`*

```typescript
import { Injectable, Logger } from '@nestjs/common';
import { InjectModel } from '@nestjs/mongoose';
import { Model } from 'mongoose';
import { User } from 'src/common/db/schemas/user.schema';
import { CreateUserDto } from 'src/common/dto/req/create-user.dto';
import { IResponse } from 'src/common/interfaces/response.interface';

const logger = new Logger('user.service');

@Injectable()
export class UserService {
  private response: IResponse;
  constructor(@InjectModel('USER_MODEL') private readonly userModel: Model<User>) {}

  // -- 注册
  async regist(user: CreateUserDto): Promise<IResponse> {
    return await this.userService.findOneByPhone(user.phone).then(async (res) => {
      // -- 如果查到了用户，则表示用户已注册
      if (res.length !== 0) {
        return { code: 1, msg: '当前手机号已注册' };
      }
      // -- 如果没有查到用户，则表示用户未注册
      try {
        const createUser = new this.userModel(user);
        await createUser.save();
        return { code: 0, msg: '注册成功' };
      } catch (error) {
        return { code: 2, msg: '注册失败，失败原因：' + error };
      }
    });
  }

  // -- 通过手机号查找用户
  async findOneByPhone(phone: string) {
    return await this.userModel.find({ phone });
  }
}
```

> **Tips：** `IResponse` 类型定义请参照 [控制器 >>](#控制器) 章节。

*`src/shared/user/user.controller.ts`*

```typescript
import { Body, Controller, Post } from '@nestjs/common';
import { CreateUserDto } from 'src/common/dto/req/create-user.dto';
import { UserService } from './user.service';

@Controller('user')
export class UserController {
  constructor(private readonly userServier: UserService) {}

  @Post('regist')
  async registUser(@Body() userDto: CreateUserDto) {
    return await this.userServier.regist(userDto);
  }
}
```

*`src/shared/user/user.module.ts`*

```typescript
import { Module } from '@nestjs/common';
import { UserService } from './user.service';
import { UserController } from './user.controller';
import { MiddlewareConsumer } from '@nestjs/common/interfaces';
import { HashPasswordMiddleware } from 'src/common/middleware/hash-password.middleware';

@Module({
  imports: [],
  providers: [UserService],
  controllers: [UserController],
})
export class UserModule {
  configure(consumer: MiddlewareConsumer) {
    consumer.apply(HashPasswordMiddleware).forRoutes('user/regist');
  }
}
```

